<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Character Similarity Finder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ====== VARIABLES ====== */
    :root {
      --bg-color: #0f0f10;
      --panel-bg: #161616;
      --panel-border: #2a2a2a;
      --text-color: #e5e5e5;
      --text-muted: #aaa;
      --accent: #36e3ff;
      --accent-gradient: linear-gradient(135deg, #36e3ff, #6b7dff);
      --input-bg: #1c1c1d;
      --input-border: #2c2c2c;
      --card-bg: #1a1a1a;
    }

    /* ====== THEMES ====== */
    .theme-light {
      --bg-color: #f9f9f9;
      --panel-bg: #ffffff;
      --panel-border: #cccccc;
      --text-color: #1a1a1a;
      --text-muted: #555;
      --accent: #4f46e5;
      --accent-gradient: linear-gradient(135deg, #4f46e5, #6366f1);
      --input-bg: #f1f1f1;
      --input-border: #ddd;
      --card-bg: #fefefe;
    }

    .theme-ttrpg {
      --bg-color: #2a1f14;
      --panel-bg: #3a2a1e;
      --panel-border: #5a422f;
      --text-color: #f3e4c5;
      --text-muted: #cbb48d;
      --accent: #b58a5b;
      --accent-gradient: linear-gradient(135deg, #b58a5b, #eacda3);
      --input-bg: #4a3a2a;
      --input-border: #b58a5b;
      --card-bg: #3a2a1e;
      background-image: radial-gradient(#3a2a1e 1px, transparent 1px),
                        radial-gradient(#3a2a1e 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
    }

    .theme-cyberpunk {
      --bg-color: #0a0c1f;
      --panel-bg: #12142b;
      --panel-border: #2a2d4f;
      --text-color: #c0ffee;
      --text-muted: #6df2ff;
      --accent: #ff00a0;
      --accent-gradient: linear-gradient(135deg, #ff00a0, #00ffff);
      --input-bg: #1a1c3a;
      --input-border: #303360;
      --card-bg: #151733;
      background: linear-gradient(135deg, #0a0c1f, #12142b);
    }

    /* ====== CORE ====== */
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.5s ease, color 0.5s ease;
    }

    h1, h2, h3 {
      color: var(--text-color);
    }

	.status {
	  text-align: center;
	  width: 100%;
	  margin-left: 0;
	  margin-right: 0;
	}
	
	.theme-selector {
	  display: flex;
	  justify-content: center;
	  width: 100%;
	}



	h1 {
	  text-align: center;
	  width: 100%;
	}


    a { color: var(--accent); }

    .container {
      display: flex;
      gap: 32px;
      padding: 40px 60px;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: flex-start;
    }

    /* ====== PANELS ====== */
    .form-column, .results-column {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 0 25px rgba(0,0,0,0.4);
      transition: background 0.5s ease, border-color 0.5s ease;
    }

    .form-column { flex: 1; min-width: 320px; }
    .results-column { flex: 2; min-width: 500px; }

    /* ====== INPUTS ====== */
    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 0.9rem;
      transition: border-color 0.2s, background 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      background: #222;
    }

    button {
      margin-top: 18px;
      padding: 10px 16px;
      background: var(--accent-gradient);
      color: var(--bg-color);
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 12px var(--accent);
    }

    /* ====== CARDS ====== */
    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .character-card {
      background: var(--card-bg);
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s;
      cursor: pointer;
      position: relative;
    }

    .character-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 0 18px rgba(54, 227, 255, 0.2);
    }

    .char-media img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .character-info {
      padding: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .character-info .meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .similarity-bar {
      height: 5px;
      background: var(--panel-border);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }

    .similarity-bar-inner {
      height: 100%;
      width: 0%;
      background: var(--accent-gradient);
      transition: width 0.5s ease;
    }

    .theme-toggle {
      background: var(--accent);
      color: var(--bg-color);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 60px;
      font-weight: 600;
    }

    .status {
      margin: 10px 60px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .status.error {
      color: #ff5050;
    }
	
		/* ====== FIX SELECT DROPDOWN ====== */
	select {
	  -webkit-appearance: none;
	  -moz-appearance: none;
	  appearance: none;
	  background-color: var(--input-bg);
	  color: var(--text-color);
	  border: 1px solid var(--input-border);
	  padding: 10px 12px;
	  border-radius: 6px;
	  font-size: 0.9rem;
	  cursor: pointer;
	}

	select option {
	  background-color: var(--input-bg);
	  color: var(--text-color);
	}

	/* optional: add a little custom arrow */
	select::-ms-expand { display: none; }
	select::after {
	  content: "‚ñº";
	  position: absolute;
	  right: 12px;
	  pointer-events: none;
	  color: var(--text-muted);
	}

	.char-placeholder {
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  height: 180px; /* same as your img height */
	  background: #222; /* dark background to match theme */
	  color: var(--text-muted);
	  font-weight: 600;
	  font-size: 1rem;
	  border-radius: 6px 6px 0 0; /* round the top corners like the image */
	  text-align: center;
	}

	.char-placeholder::before {
	  content: "üñºÔ∏è"; /* optional icon for visual flair */
	  display: block;
	  font-size: 2rem;
	  margin-bottom: 6px;
	}


  </style>
</head>



<body>

  <h1>Find Your Most Similar Characters</h1>
  <div class="status" id="status">Loading characters...</div>

	<div class="theme-selector">
	  <button class="theme-toggle" onclick="cycleTheme()">Change Theme</button>
	</div>



  <div class="container">
    <div class="form-column">
		<form id="testForm" onsubmit="runSimilarityCheck(); return false;">
	  
		<label>Search by Name</label>
		<input type="text" id="nameSearch" placeholder="Enter character name...">

        <label>MBTI (function pair)</label>
        <select id="mbti">
          <option value="">‚Äî any ‚Äî</option>
          <option value="Ni/Te">Ni/Te</option>
          <option value="Ni/Fe">Ni/Fe</option>
          <option value="Ni/Ti">Ni/Ti</option>
          <option value="Ne/Fi">Ne/Fi</option>
          <option value="Ne/Ti">Ne/Ti</option>
          <option value="Ne/Fe">Ne/Fe</option>
          <option value="Si/Te">Si/Te</option>
          <option value="Si/Fe">Si/Fe</option>
          <option value="Si/Ti">Si/Ti</option>
          <option value="Se/Fi">Se/Fi</option>
          <option value="Se/Ti">Se/Ti</option>
          <option value="Se/Fe">Se/Fe</option>
          <option value="Ti/Ne">Ti/Ne</option>
          <option value="Ti/Se">Ti/Se</option>
          <option value="Ti/Si">Ti/Si</option>
          <option value="Te/Ni">Te/Ni</option>
          <option value="Te/Si">Te/Si</option>
          <option value="Te/Se">Te/Se</option>
          <option value="Fi/Ne">Fi/Ne</option>
          <option value="Fi/Se">Fi/Se</option>
          <option value="Fi/Si">Fi/Si</option>
          <option value="Fe/Ni">Fe/Ni</option>
          <option value="Fe/Si">Fe/Si</option>
          <option value="Fe/Se">Fe/Se</option>
          <option value="Ni/Fi">Ni/Fi</option>
          <option value="Ne/Te">Ne/Te</option>
          <option value="Si/Fi">Si/Fi</option>
          <option value="Se/Te">Se/Te</option>
          <option value="Ti/Ni">Ti/Ni</option>
          <option value="Te/Ne">Te/Ne</option>
          <option value="Fi/Ni">Fi/Ni</option>
          <option value="Fe/Ne">Fe/Ne</option>
        </select>

        <label>MBTI (4-letter)</label>
        <select id="fourletter">
          <option value="">‚Äî any ‚Äî</option>
          <option>INTJ</option><option>INFJ</option><option>INTP</option><option>INFP</option>
          <option>ENTJ</option><option>ENTP</option><option>ENFJ</option><option>ENFP</option>
          <option>ISTJ</option><option>ISFJ</option><option>ISTP</option><option>ISFP</option>
          <option>ESTJ</option><option>ESFJ</option><option>ESTP</option><option>ESFP</option>
        </select>

        <label>Enneagram (example: 5)</label>
        <input id="enneagram" type="text" placeholder="e.g. 5">

        <label>Enneagram Instinct</label>
        <select id="cep">
          <option value="">‚Äî any ‚Äî</option>
          <option>SO1</option><option>SP1</option><option>SX1</option><option>SO2</option><option>SP2</option><option>SX2</option>
          <option>SO3</option><option>SP3</option><option>SX3</option><option>SO4</option><option>SP4</option><option>SX4</option>
          <option>SO5</option><option>SP5</option><option>SX5</option><option>SO6</option><option>SP6</option><option>SX6</option>
          <option>SO7</option><option>SP7</option><option>SX7</option><option>SO8</option><option>SP8</option><option>SX8</option>
          <option>SO9</option><option>SP9</option><option>SX9</option>
        </select>
		
		<label>Enneagram Tritype</label>
		<input id="tritype" type="text" placeholder="e.g. 594, 936, 471">


        <label>Socionics subtype</label>
        <input id="socionics" type="text" placeholder="e.g. ILI-Te">

        <label>Neurotype</label>
        <select id="neurotype">
          <option value="">‚Äî any ‚Äî</option>
          <option>Computer</option><option>Analyst</option><option>Fascinator</option><option>Newtype</option>
          <option>Technician</option><option>Astute</option><option>Overseer</option><option>Aesthetician</option>
          <option>Contemplative</option><option>Understanding</option><option>Externalist</option><option>Sensate</option>
          <option>Bookkeeper</option><option>Level-Headed</option><option>Clearsighted</option><option>Instinctual</option>
        </select>

        <label>Classpect</label>
        <input id="classpect" type="text" placeholder="e.g. Seer of Light">

        <label>OPS Animals</label>
        <input id="ops" type="text" placeholder="e.g. CS/PB">

        <label>Attitudinal Psyche</label>
        <input id="ap" type="text" placeholder="e.g. FEVL">
		
		<label>5-Scale Type (e.g. +DEP +ENG)</label>
		<input id="fivecode" type="text" placeholder="+DEP +ENG">


        <label>Genre (filter)</label>
        <select id="genreFilter"><option value="">All</option></select>

        <label>Show/Series</label>
        <select id="notesFilter"><option value="">All</option></select>

        <br>
        <button type="submit" id="findBtn">Find Matches</button>
        <button type="button" id="savePresetBtn">Save Preset</button>
		<button type="button" id="clearBtn" style="background:#444;">Clear</button>



        <div class="presets" id="presetsContainer"></div>



        <h3>Scoring Toggles</h3>
        <label><input type="checkbox" id="useMbti" checked> Use MBTI (w/ Jumpers)</label>
        <label><input type="checkbox" id="use4Letter" checked> Use MBTI (4-letter)</label>
        <label><input type="checkbox" id="useEnneagram" checked> Use Enneagram</label>
		<label><input type="checkbox" id="useTritype" checked> Use Enneagram Tritype</label>
        <label><input type="checkbox" id="useSocionics" checked> Use Socionics</label>
        <label><input type="checkbox" id="useCep" checked> Use Enneagram Instinct</label>
        <label><input type="checkbox" id="useNeurotype" checked> Use Neurotype</label>
        <label><input type="checkbox" id="useClasspect" checked> Use Classpect</label>
        <label><input type="checkbox" id="useOps" checked> Use OPS Animals</label>
        <label><input type="checkbox" id="useAp" checked> Use Attitudinal Psyche</label>
		<label><input type="checkbox" id="useFivecode" checked> Use 5-Scale Typology</label>

	

        <h3>Exclude</h3>
        <label><input type="checkbox" id="excludeSide"> Exclude side / supporting characters</label>
        <label><input type="checkbox" id="excludeMC"> Exclude main characters / MCs</label>
        <label><input type="checkbox" id="excludeVillain"> Exclude villains / antagonists</label>

      </form>
    </div>

    <div class="results-column">
      <div id="results" class="results"></div>
    </div>
  </div>



  <script>
  
    const themes = ["theme-light", "theme-ttrpg", "theme-cyberpunk"];
    let currentTheme = 0;


	function clearFormFields() {
	  const form = document.getElementById('testForm');

	  // Reset text inputs and selects
	  form.querySelectorAll('input[type="text"], select').forEach(el => {
		el.value = '';
	  });

	  // Reset checkboxes to unchecked
	  form.querySelectorAll('input[type="checkbox"]').forEach(el => {
		el.checked = false;
	  });

	  // Re-enable the default scoring toggles to whatever you want
	  // (You can remove this block if you want them all off instead.)
	  document.getElementById('useMbti').checked = true;
	  document.getElementById('use4Letter').checked = true;
	  document.getElementById('useEnneagram').checked = true;
	  document.getElementById('useSocionics').checked = true;
	  document.getElementById('useNeurotype').checked = true;
	  document.getElementById('useClasspect').checked = true;
	  document.getElementById('useOps').checked = true;
	  document.getElementById('useAp').checked = true;
	  document.getElementById('useCep').checked = true;
	  document.getElementById('useFivecode').checked = true;
	  document.getElementById('useTritype').checked = true;


	  // Clear search results so the user has visual feedback
	  resultsEl.innerHTML = '';

	  // Optional UI status update
	  setStatus("Form cleared.");
	}

	// hook up the button
	document.getElementById('clearBtn').addEventListener('click', clearFormFields);

    function cycleTheme() {
      document.body.classList.remove(...themes);
      currentTheme = (currentTheme + 1) % themes.length;
      document.body.classList.add(themes[currentTheme]);
    }

    document.body.classList.add(themes[currentTheme]);

    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const findBtn = document.getElementById('findBtn');
    const savePresetBtn = document.getElementById('savePresetBtn');
    const presetsContainer = document.getElementById('presetsContainer');

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = isError ? 'status error' : 'status';
    }

    function getProp(obj, ...keys) {
      for (const k of keys) {
        if (!k) continue;
        if (k in obj && obj[k] != null) return obj[k];
      }
      return '';
    }

    let characters = [];

    const neuroGrid = {
      "Computer": [0,0],"Analyst":[1,0],"Fascinator":[2,0],"Newtype":[3,0],
      "Technician":[0,1],"Astute":[1,1],"Overseer":[2,1],"Aesthetician":[3,1],
      "Contemplative":[0,2],"Understanding":[1,2],"Externalist":[2,2],"Sensate":[3,2],
      "Bookkeeper":[0,3],"Level-Headed":[1,3],"Clearsighted":[2,3],"Instinctual":[3,3]
    };

    function populateGenreFilter() {
      if (!characters || characters.length === 0) return;
      const genreSet = new Set();
      characters.forEach(char => {
        if (!char) return;
        const raw = char.genre || char.genres || char.category || '';
        if (!raw) return;
        String(raw).split('/').forEach(part => {
          const t = part.trim();
          if (t) genreSet.add(t);
        });
      });
      const sel = document.getElementById('genreFilter');
      sel.innerHTML = '<option value="">All</option>';
      Array.from(genreSet).sort((a,b) => a.localeCompare(b, undefined, { numeric:true, sensitivity:'base' }))
        .forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function populateNotesFilter() {
      if (!characters || characters.length === 0) return;
      const set = new Set();
      characters.forEach(c => {
        if (!c) return;
        const notes = c.notes || c.show || c.series || '';
        if (!notes) return;
        if (Array.isArray(notes)) {
          notes.forEach(n => { if (n) { const s=String(n).trim(); if(s) set.add(s); } });
        } else {
          String(notes).split('/').forEach(part => { const t = part.trim(); if (t) set.add(t); });
        }
      });
      const sel = document.getElementById('notesFilter');
      sel.innerHTML = '<option value="">All</option>';
      Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, { numeric:true, sensitivity:'base' }))
        .forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function parsePair(raw) {
      if (!raw) return [];
      const s = String(raw).trim();
      if (!s) return [];
      if (s.includes('/')) return s.split('/').map(x=>x.trim()).filter(Boolean);
      if (s.includes(' ')) return s.split(/\s+/).map(x=>x.trim()).filter(Boolean);
      const m = s.match(/.{1,2}/g);
      return m ? m.map(x=>x.trim()) : [s];
    }

    function mbtiPairScore(a,b) {
      const A = parsePair(a), B = parsePair(b);
      if (!A.length || !B.length) return 0;
      if (A[0] === B[0] && A[1] === B[1]) return 1;
      if (A[0] === B[0]) return 0.6;
      if (A[1] === B[1]) return 0.4;
      if (A.some(x => B.includes(x))) return 0.2;
      return 0;
    }

	function tritypeMatch(u, c) {
	  if (!u || !c) return 0;

	  const clean = t =>
		String(t)
		  .replace(/[^\d]/g, '')  // strip everything except digits
		  .slice(0,3)             // take first 3 digits only
		  .split('');

	  const U = clean(u);
	  const C = clean(c);

	  if (U.length < 3 || C.length < 3) return 0;

	  // core mismatch ‚Üí zero score
	  if (U[0] !== C[0]) return 0;

	  // Compare the sets of fixes (2 + 3)
	  const uFix = [U[1], U[2]].sort().join('');
	  const cFix = [C[1], C[2]].sort().join('');

	  return uFix === cFix ? 1 : 0.5;
	}


    function opsMatch(u, c) {
      if (!u || !c) return 0;
      const U = String(u).trim().toUpperCase();
      const C = String(c).trim().toUpperCase();
      if (!U || !C) return 0;
      const uParts = U.split('/').map(p=>p.trim()).filter(Boolean);
      const cParts = C.split('/').map(p=>p.trim()).filter(Boolean);
      if (uParts.join('/') === cParts.join('/')) return 1;
      let matches = 0;
      const len = Math.min(uParts.length, cParts.length);
      for (let i=0;i<len;i++) {
        if (uParts[i] === cParts[i]) matches++;
      }
      return matches / Math.max(uParts.length, cParts.length);
    }

    function cepMatch(u, c) {
      if (!u || !c) return 0;
      const U = String(u).trim().toUpperCase();
      const C = String(c).trim().toUpperCase();
      if (U === C) return 1;
      if (U.length >= 3 && C.length >= 3 && U[2] === C[2]) return 0.5;
      return 0;
    }

    function neurotypeScore(uT,cT) {
      if (!uT || !cT) return 0;
      const u = neuroGrid[String(uT).trim()], c = neuroGrid[String(cT).trim()];
      if (!u || !c) return 0;
      const dx = u[0]-c[0], dy = u[1]-c[1];
      return 1 - Math.sqrt(dx*dx+dy*dy) / Math.sqrt(18);
    }

    function textMatch(a,b) {
      if (!a || !b) return 0;
      return String(a).trim().toLowerCase() === String(b).trim().toLowerCase() ? 1 : 0;
    }

    function fourLetterMatch(u,c) {
      if (!u || !c) return 0;
      const U = String(u).trim().toUpperCase(), C = String(c).trim().toUpperCase();
      if (U === C) return 1;
      let m=0;
      for (let i=0;i<4;i++) if (U[i] === C[i]) m++;
      return m/4;
    }

    function enneagramMatch(u,c) {
      if (!u || !c) return 0;
      const um = String(u).match(/\d/), cm = String(c).match(/\d/);
      if (!um || !cm) return 0;
      return um[0] === cm[0] ? 1 : 0;
    }

    // computeScore (flexible property names)
	function computeScore(user, char) {
	  const charMbti = getProp(char, 'mbti', 'saviors', 'function', 'functions', 'func', 'fn');
	  const charFour = getProp(char, 'fourletter', 'four', 'mbti4');
	  const charEnn = getProp(char, 'enneagram', 'ennea');
	  const charSoc = getProp(char, 'socionics', 'soc');
	  const charNeuro = getProp(char, 'neurotype', 'neuro');
	  const charClass = getProp(char, 'classpect', 'class');
	  const charAp = getProp(char, 'ap', 'attitudinal', 'attitude');
	  const charCep = getProp(char, 'cep', 'instinct');
	  const charOps = getProp(char, 'ops', 'animals', 'ops_animals', 'animal');
	  const charFive  = getProp(char, 'fivecode', '5code', '5Code', 'span5', 'scale5');
	  const charTri = getProp(char, 'tritype', 'Tritype', 'tri');

	  const weights = {
		mbti: 0.25, fourletter: 0.15, enneagram: 0.10, socionics: 0.08,
		neurotype: 0.10, classpect: 0.05, ap: 0.05, cep: 0.05, ops: 0.05, 
		fivecode: 0.10, tritype: 0.08,
	  };

	  const active = [];
	  if (document.getElementById('useMbti').checked) active.push('mbti');
	  if (document.getElementById('use4Letter').checked) active.push('fourletter');
	  if (document.getElementById('useEnneagram').checked) active.push('enneagram');
	  if (document.getElementById('useSocionics').checked) active.push('socionics');
	  if (document.getElementById('useNeurotype').checked) active.push('neurotype');
	  if (document.getElementById('useClasspect').checked) active.push('classpect');
	  if (document.getElementById('useAp').checked) active.push('ap');
	  if (document.getElementById('useCep').checked) active.push('cep');
	  if (document.getElementById('useOps').checked) active.push('ops');
	  if (document.getElementById('useFivecode').checked) active.push('fivecode');
	  if (document.getElementById('useTritype').checked) active.push('tritype');



	  const totalWeight = active.reduce((s,k)=> s + (weights[k]||0), 0) || 1;
	  const w = k => (weights[k]||0)/totalWeight;

	  let score = 0;
	  if (active.includes('mbti')) score += mbtiPairScore(user.mbti, charMbti) * w('mbti');
	  if (active.includes('fourletter')) score += fourLetterMatch(user.fourletter, charFour) * w('fourletter');
	  if (active.includes('enneagram')) score += enneagramMatch(user.enneagram, charEnn) * w('enneagram');
	  if (active.includes('socionics')) score += textMatch(user.socionics, charSoc) * w('socionics');
	  if (active.includes('neurotype')) score += neurotypeScore(user.neurotype, charNeuro) * w('neurotype');
	  if (active.includes('classpect')) score += textMatch(user.classpect, charClass) * w('classpect');
	  if (active.includes('ap')) score += textMatch(user.ap, charAp) * w('ap');
	  if (active.includes('cep')) score += cepMatch(user.cep, charCep) * w('cep');
	  if (active.includes('ops')) score += opsMatch(user.ops, charOps) * w('ops');
	  if (active.includes('fivecode')) score += fivecodeMatch(user.fivecode, charFive) * w('fivecode');
	  if (active.includes('tritype')) score += tritypeMatch(user.tritype, charTri) * w('tritype');


	  return score;
	}

	function fivecodeMatch(user, char) {
	  if (!user || !char) return 0;

	  const u = user.toUpperCase().trim().split(/\s+/);
	  const c = char.toUpperCase().trim().split(/\s+/);

	  if (u.length !== 2 || c.length !== 2) return 0;

	  let matches = 0;
	  if (u[0] === c[0]) matches++;
	  if (u[1] === c[1]) matches++;

	  return matches / 2;  // 1.0 = perfect match, 0.5 = partial, 0 = mismatch
	}

    // heuristics for role detection (used by exclude toggles)
    function isSideCharacter(c) {
      // check explicit booleans
      if (c.is_side === true || c.is_supporting === true || c.is_minor === true) return true;
      const r = (getProp(c,'role','roles','type','tags','tag') || '').toString().toLowerCase();
      if (!r) return false;
      return r.includes('side') || r.includes('support') || r.includes('minor') || r.includes('supporting');
    }
    function isMainCharacter(c) {
      if (c.is_main === true || c.is_protagonist === true || c.is_lead === true) return true;
      const r = (getProp(c,'role','roles','type','tags','tag') || '').toString().toLowerCase();
      if (!r) return false;
      return r.includes('main') || r.includes('protagonist') || r.includes('lead') || r.includes('mc') || r.includes('player');
    }
    function isVillainCharacter(c) {
      if (c.is_villain === true || c.is_antagonist === true) return true;
      const r = (getProp(c,'role','roles','type','tags','tag') || '').toString().toLowerCase();
      if (!r) return false;
      return r.includes('villain') || r.includes('antagonist') || r.includes('enemy');
    }

    // Render results as cards (with image support)
    function runSimilarityCheck() {
      if (!characters || characters.length === 0) {
        resultsEl.innerHTML = '<p class="error">No character data loaded.</p>';
        return;
      }


      const user = {
        mbti: (document.getElementById('mbti').value || '').trim(),
        enneagram: (document.getElementById('enneagram').value || '').trim(),
        socionics: (document.getElementById('socionics').value || '').trim(),
        neurotype: (document.getElementById('neurotype').value || '').trim(),
        classpect: (document.getElementById('classpect').value || '').trim(),
        ap: (document.getElementById('ap').value || '').trim(),
        cep: (document.getElementById('cep').value || '').trim(),
        fourletter: (document.getElementById('fourletter').value || '').trim(),
        ops: (document.getElementById('ops').value || '').trim(),
		tritype: (document.getElementById('tritype').value || '').trim(),
		fivecode: (document.getElementById('fivecode').value || '').trim(),
		tritype: (document.getElementById('tritype').value || '').trim(),
      };

      const genreFilterRaw = document.getElementById('genreFilter').value;
      const genreFilter = genreFilterRaw ? String(genreFilterRaw).trim().toLowerCase() : '';
      const selectedNotesRaw = document.getElementById('notesFilter').value;
      const selectedNotes = selectedNotesRaw ? String(selectedNotesRaw).trim().toLowerCase() : '';

      let filtered = characters.slice();

      // apply genre / notes filters
      if (genreFilter) {
        filtered = filtered.filter(c => {
          const g = c.genre || c.genres || c.category || '';
          if (!g) return false;
          return String(g).toLowerCase().split('/').map(x=>x.trim()).some(x => x === genreFilter);
        });
      }
      if (selectedNotes) {
        filtered = filtered.filter(c => {
          const notes = c.notes || c.show || c.series || '';
          if (!notes) return false;
          const arr = Array.isArray(notes) ? notes : String(notes).split('/');
          return arr.map(x => String(x).trim().toLowerCase()).includes(selectedNotes);
        });
      }
	  
	  const nameQuery = document.getElementById('nameSearch').value.trim().toLowerCase();
		if (nameQuery) {
		  filtered = filtered.filter(c => {
			const name = c.name || c.character || c.title || '';
			return name.toLowerCase().includes(nameQuery);
		  });
		}


      // apply exclude toggles
      if (document.getElementById('excludeSide').checked) filtered = filtered.filter(c => !isSideCharacter(c));
      if (document.getElementById('excludeMC').checked) filtered = filtered.filter(c => !isMainCharacter(c));
      if (document.getElementById('excludeVillain').checked) filtered = filtered.filter(c => !isVillainCharacter(c));

      if (filtered.length === 0) {
        resultsEl.innerHTML = '<h2>No Results</h2><p>No characters found matching the selected filters.</p>';
        return;
      }

      // score & sort
      const scored = filtered.map(c => ({ ...c, similarity: computeScore(user, c) }));
      scored.sort((a,b)=> b.similarity - a.similarity);
      const top = scored.slice(0, 25);

      // Render grid of cards
      resultsEl.innerHTML = '<h2>Top Matches</h2><div class="character-grid">' +
        top.map(c => {
          // pick image from common field names
          const img = getProp(c, 'image', 'img', 'picture', 'imageUrl', 'url', 'src');
          const name = c.name || c.character || c.title || 'Unnamed';
          const showText = c.notes || c.show || c.series || 'N/A';
          const genreText = c.genre || 'N/A';
          const four = c.fourletter || c.mbti4 || 'N/A';
          const funcs = getProp(c, 'mbti', 'saviors', 'function', 'functions', 'func', 'fn') || 'N/A';
          const opsText = getProp(c, 'ops', 'animals', 'ops_animals', 'animal') || 'N/A';
          const similarityPct = Math.round((c.similarity || 0) * 100);

          // inline safe HTML; escape values
          return `
            <div class="character-card" data-name="${escapeHtml(name)}">
              <div class="char-media">
                ${ img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">` : '' }
                <div class="char-placeholder" style="${img ? 'display:none' : 'display:flex'}">
                  ${ img ? '' : 'No image' }
                </div>
              </div>
              <div class="character-info">
                <h3>${escapeHtml(name)}</h3>
                <div class="meta">${escapeHtml(showText)} ‚Äî ${escapeHtml(genreText)}</div>
                <div class="small"><strong>Func:</strong> ${escapeHtml(funcs)} ‚Ä¢ <strong>4L:</strong> ${escapeHtml(four)}</div>
                <div class="small"><strong>Instinct:</strong> ${escapeHtml(c.cep || 'N/A')} ‚Ä¢ <strong>AP:</strong> ${escapeHtml(c.ap || 'N/A')}</div>
                <div class="small"><strong>OPS:</strong> ${escapeHtml(opsText)} ‚Ä¢ <strong>Neuro:</strong> ${escapeHtml(c.neurotype || 'N/A')}</div>
				<div class="small"><strong>5Span:</strong> ${escapeHtml(c["5Code"] || 'N/A')}</div>
				<div class="small"><strong>Tritype:</strong> ${escapeHtml(c.tritype || c.Tritype || 'N/A')}</div>
                <div style="margin-top:10px;font-weight:600;color:#222">${similarityPct}%</div>
				<div class="similarity-bar">
				  <div class="similarity-bar-inner" style="width:${similarityPct}%"></div>
				</div>
              </div>
            </div>
          `;
        }).join('') +
      '</div>';
    }

    // simple html-escape for inserted fields
    function escapeHtml(s){
      if (s === null || s === undefined) return '';
      return String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
    }

// --- PRESETS ---
const PRESET_KEY = 'character_presets_v1';

function loadPresetsFromStorage(){ 
  try { 
    return JSON.parse(localStorage.getItem(PRESET_KEY)||'[]'); 
  } catch(e) { 
    return []; 
  } 
}

function savePresetsToStorage(arr){ 
  localStorage.setItem(PRESET_KEY, JSON.stringify(arr||[])); 
}

function renderPresets(){
  const arr = loadPresetsFromStorage();
  presetsContainer.innerHTML = '';
  if (!arr.length) { 
    presetsContainer.innerHTML = '<div class="muted">No presets saved.</div>'; 
    return; 
  }

  arr.forEach((p,i) => {
    const row = document.createElement('div'); 
    row.className='preset-row';

    // Preset button shows name + all fields
    const btn = document.createElement('button');
    btn.textContent = `${p.name || `Preset ${i+1}`} ‚Äî ${p.mbti||'-'} | ${p.fourletter||'-'} | ${p.enneagram||'-'} | ${p.socionics||'-'} | ${p.neurotype||'-'} | ${p.classpect||'-'} | ${p.ap||'-'} | ${p.cep||'-'} | ${p.ops||'-'} ${p.fivecode || '-'}
`;
    btn.addEventListener('click', () => loadPreset(p));
    row.appendChild(btn);

    // Delete button
    const del = document.createElement('button');
    del.textContent = '‚ùå'; 
    del.style.background='#f88'; 
    del.style.border='none'; 
    del.style.borderRadius='4px'; 
    del.addEventListener('click', () => { 
      const updated = loadPresetsFromStorage().filter((_,idx)=>idx!==i); 
      savePresetsToStorage(updated); 
      renderPresets(); 
    });
    row.appendChild(del);

    presetsContainer.appendChild(row);
  });

  // Clear all button
  const clearAll = document.createElement('button'); 
  clearAll.textContent='Clear All Presets'; 
  clearAll.style.marginTop='8px'; 
  clearAll.style.background='#faa';
  clearAll.addEventListener('click', () => { 
    if(confirm('Delete ALL presets?')){ 
      localStorage.removeItem(PRESET_KEY); 
      renderPresets(); 
    } 
  });
  presetsContainer.appendChild(clearAll);
}

function makePresetFromForm() {
  // Ask user for a name
  const name = prompt("Enter a name for this preset:")?.trim();
  if(!name) return; // cancel if empty

  const preset = {
    name,
    mbti: (document.getElementById('mbti').value || '').trim(),
    fourletter: (document.getElementById('fourletter').value || '').trim(),
    enneagram: (document.getElementById('enneagram').value || '').trim(),
    socionics: (document.getElementById('socionics').value || '').trim(),
    neurotype: (document.getElementById('neurotype').value || '').trim(),
    classpect: (document.getElementById('classpect').value || '').trim(),
    ap: (document.getElementById('ap').value || '').trim(),
    cep: (document.getElementById('cep').value || '').trim(),
    ops: (document.getElementById('ops').value || '').trim(),
	fivecode: (document.getElementById('fivecode').value || '').trim(),

  };
  const arr = loadPresetsFromStorage(); 
  arr.push(preset); 
  savePresetsToStorage(arr); 
  renderPresets();
}

function loadPreset(preset) {
  document.getElementById('mbti').value = preset.mbti || '';
  document.getElementById('fourletter').value = preset.fourletter || '';
  document.getElementById('enneagram').value = preset.enneagram || '';
  document.getElementById('socionics').value = preset.socionics || '';
  document.getElementById('neurotype').value = preset.neurotype || '';
  document.getElementById('classpect').value = preset.classpect || '';
  document.getElementById('ap').value = preset.ap || '';
  document.getElementById('cep').value = preset.cep || '';
  document.getElementById('ops').value = preset.ops || '';
  document.getElementById('fivecode').value = preset.fivecode || '';
  try { runSimilarityCheck(); } catch(e){ console.error(e); }
}

// event listeners
findBtn.addEventListener('click', () => {
  try { runSimilarityCheck(); } catch (err) { 
    console.error('runSimilarityCheck error:', err); 
    resultsEl.innerHTML = '<p class="error">Error running search ‚Äî see console.</p>'; 
  }
});
savePresetBtn.addEventListener('click', makePresetFromForm);
document.addEventListener('DOMContentLoaded', renderPresets);



  </script>
  
    <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase config (as requested)
    const SUPABASE_URL = "https://gmfkzzswgpewnylyceii.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtZmt6enN3Z3Bld255bHljZWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODEyNzEsImV4cCI6MjA3ODU1NzI3MX0.pYWxDWYRDRNjrWGZJsM9KuW8cMWw_OktrRmlknAvOk0";

    // create the client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = isError ? 'status error' : 'status';
    }
    // load rows from your Supabase table named "characters" (change if your table name differs)
    async function loadCharacters() {
      try {
        setStatus('Loading characters from Supabase...');
        const { data, error } = await supabaseClient
          .from('characters')
          .select('*')
          .order('name', { ascending: true });

        if (error) {
          console.error('Supabase error', error);
          setStatus('Error loading from Supabase (see console)', true);
          return;
        }
        // data is an array
        characters = Array.isArray(data) ? data : [];
        setStatus('Characters loaded: ' + characters.length + '. Ready.');
        // populate UI controls
        populateNotesFilter();
        populateGenreFilter();
        renderPresets();
        document.getElementById('findBtn').disabled = false;
      } catch (e) {
        console.error(e);
        setStatus('Unexpected error loading characters', true);
      }
    }

    // fire the loader
    loadCharacters();
  </script>
</body>
</html>
